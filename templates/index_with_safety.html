{% extends "base.html" %}

{% block title %}Cinematch - AI Movie Recommendations{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div id="app" class="min-h-screen bg-gray-900">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-red-500">
                    <i class="fas fa-film mr-2"></i>Cinematch
                </h1>
                <div class="flex items-center space-x-4">
                    {% if current_user.is_authenticated %}
                        <div class="flex items-center space-x-2">
                            <!-- Safety Status Indicator -->
                            <div id="safetyStatusIndicator" class="flex items-center">
                                <i class="fas fa-shield-alt text-green-400" title="Safety systems active"></i>
                            </div>
                            
                            <!-- User Tier Badge -->
                            <span class="badge bg-{{ 'success' if current_user.current_tier == 'premium' else 'primary' if current_user.current_tier == 'basic' else 'secondary' }}">
                                {{ current_user.current_tier|title }}
                            </span>
                            
                            <span class="text-gray-300">Welcome, {{ current_user.username }}</span>
                            
                            <!-- Settings Dropdown -->
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="/subscription">
                                        <i class="fas fa-star me-2"></i>Subscription
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="showSafetySettings">
                                        <i class="fas fa-shield-alt me-2"></i>Safety Settings
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light">
                            <i class="fas fa-sign-in-alt me-1"></i> Login
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="row">
            <!-- Left Column - Chat Interface -->
            <div class="col-lg-8">
                <!-- Welcome Message -->
                <div class="text-center mb-4">
                    <h2 class="text-4xl font-bold text-white mb-3">Discover Your Next Favorite Movie</h2>
                    <p class="text-xl text-gray-400">Tell me what you're in the mood for, and I'll find the perfect film for you.</p>
                </div>

                <!-- Chat Interface -->
                <div class="card bg-dark border-0 shadow-lg">
                    <div class="card-body">
                        <!-- Chat Messages -->
                        <div id="chat-messages" class="chat-container mb-4">
                            <div class="message bot-message">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar bg-primary rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                    </div>
                                    <div class="message-content">
                                        <p class="text-light">
                                            Hello! I'm your AI movie assistant. Tell me what kind of movie you're looking for, 
                                            and I'll help you find something great to watch.
                                        </p>
                                        <small class="text-muted">Just now</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <form id="chat-form" class="d-flex gap-2">
                            <input type="text" id="user-input" class="form-control form-control-lg" 
                                   placeholder="What kind of movie are you in the mood for?" 
                                   maxlength="1000" required>
                            <button type="submit" id="send-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>

                        <!-- Content Warning Display -->
                        <div id="contentWarning" class="alert alert-warning mt-2 d-none">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="contentWarningText"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Controls and Info -->
            <div class="col-lg-4">
                <!-- Parameter Controls (visible to authenticated users) -->
                {% if current_user.is_authenticated %}
                <div class="mb-4">
                    {% include 'components/parameter_controls.html' %}
                </div>
                {% endif %}

                <!-- Usage Information -->
                <div class="card bg-dark border-0 shadow-lg mb-4">
                    <div class="card-header bg-secondary border-0">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-info-circle me-2"></i>Usage Information
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if current_user.is_authenticated %}
                            {% set usage_info = get_user_usage_info(current_user) %}
                            {% if usage_info %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Today's Usage:</span>
                                    <span class="text-light">{{ usage_info.queries_today }}/{{ usage_info.daily_limit }}</span>
                                </div>
                                <div class="progress mb-3" style="height: 8px;">
                                    <div class="progress-bar" style="width: {{ (usage_info.queries_today / usage_info.daily_limit * 100)|round }}%"></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Plan:</span>
                                    <span class="badge bg-{{ 'success' if current_user.current_tier == 'premium' else 'primary' if current_user.current_tier == 'basic' else 'secondary' }}">
                                        {{ current_user.current_tier|title }}
                                    </span>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted mb-3">Sign in to track your usage and access advanced features.</p>
                            <a href="{{ url_for('auth.login') }}" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt me-1"></i> Sign In
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Subscription CTA (for free users) -->
                {% if current_user.is_authenticated and current_user.current_tier == 'free' %}
                <div class="card bg-gradient-primary border-0 shadow-lg">
                    <div class="card-body text-center">
                        <h6 class="fw-bold text-white mb-2">Upgrade for More!</h6>
                        <p class="text-white-50 small mb-3">
                            Get unlimited queries, advanced AI agents, and premium features.
                        </p>
                        <a href="/subscription" class="btn btn-light btn-sm">
                            <i class="fas fa-star me-1"></i> Upgrade Now
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 mt-auto py-4">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">
                <i class="fas fa-shield-alt me-1"></i> Protected by advanced AI safety systems |
                <a href="/privacy" class="text-gray-300 hover:text-white">Privacy Policy</a> |
                <a href="/terms" class="text-gray-300 hover:text-white">Terms of Service</a>
            </p>
        </div>
    </footer>
</div>

<!-- Age Verification Modal -->
{% include 'components/age_verification_modal.html' %}

<!-- Safety Dashboard Modal (for admins) -->
{% if current_user.is_authenticated and current_user.is_admin %}
<div class="modal fade" id="safetyDashboardModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Safety Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                {% include 'components/safety_dashboard.html' %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Main application JavaScript
(function() {
    'use strict';

    let isProcessing = false;
    let currentParameters = {};

    document.addEventListener('DOMContentLoaded', function() {
        initializeChat();
        setupEventListeners();
        
        // Check age verification on page load
        if (!window.isAgeVerified || !window.isAgeVerified()) {
            // Age verification modal will show automatically if needed
        }
    });

    function initializeChat() {
        // Initialize chat interface
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Load any existing chat history
        loadChatHistory();
    }

    function setupEventListeners() {
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        chatForm.addEventListener('submit', handleChatSubmit);
        
        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Parameter change listener
        document.addEventListener('parametersChanged', function(event) {
            currentParameters = event.detail.parameters;
        });

        // Safety settings button
        const safetySettingsBtn = document.getElementById('showSafetySettings');
        if (safetySettingsBtn) {
            safetySettingsBtn.addEventListener('click', showSafetyDashboard);
        }
    }

    async function handleChatSubmit(event) {
        event.preventDefault();
        
        if (isProcessing) return;

        const userInput = document.getElementById('user-input');
        const message = userInput.value.trim();
        
        if (!message) return;

        // Check age verification
        if (!window.isAgeVerified || !window.isAgeVerified()) {
            showAgeVerificationModal();
            return;
        }

        isProcessing = true;
        updateSendButton(true);

        // Add user message to chat
        addMessage(message, 'user');
        userInput.value = '';

        try {
            // Prepare request data
            const requestData = {
                message: message,
                ai_parameters: currentParameters,
                session_id: getSessionId()
            };

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();

            if (!response.ok) {
                if (response.status === 403) {
                    // Age verification required
                    showAgeVerificationModal();
                    return;
                } else if (response.status === 429) {
                    // Rate limit exceeded
                    showError('Rate limit exceeded. Please wait before sending another message.');
                    return;
                } else {
                    throw new Error(data.error || 'Failed to send message');
                }
            }

            // Add bot response to chat
            addMessage(data.response, 'bot', data.safety_info);

            // Show content warnings if any
            if (data.warnings && data.warnings.length > 0) {
                showContentWarnings(data.warnings);
            }

        } catch (error) {
            console.error('Chat error:', error);
            showError('Sorry, I encountered an error. Please try again.');
        } finally {
            isProcessing = false;
            updateSendButton(false);
            userInput.focus();
        }
    }

    function addMessage(content, type, safetyInfo = null) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message mb-3`;

        const avatar = type === 'user' 
            ? '<i class="fas fa-user"></i>'
            : '<i class="fas fa-robot"></i>';
        
        const avatarClass = type === 'user' ? 'bg-secondary' : 'bg-primary';

        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0 me-3">
                    <div class="avatar ${avatarClass} rounded-circle d-flex align-items-center justify-content-center">
                        ${avatar}
                    </div>
                </div>
                <div class="message-content">
                    <div class="message-text bg-${type === 'user' ? 'secondary' : 'dark'} rounded p-3 mb-1">
                        ${content}
                    </div>
                    ${safetyInfo ? `
                        <div class="safety-info mt-1">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                Content filtered and verified safe
                            </small>
                        </div>
                    ` : ''}
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                </div>
            </div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateSendButton(loading) {
        const sendBtn = document.getElementById('send-btn');
        if (loading) {
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            sendBtn.disabled = true;
        } else {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
        }
    }

    function showContentWarnings(warnings) {
        const warningDiv = document.getElementById('contentWarning');
        const warningText = document.getElementById('contentWarningText');
        
        if (warnings.length > 0) {
            warningText.textContent = warnings.join('; ');
            warningDiv.classList.remove('d-none');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                warningDiv.classList.add('d-none');
            }, 10000);
        }
    }

    function showError(message) {
        // Create error toast
        const toast = document.createElement('div');
        toast.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) {
                const bsAlert = new bootstrap.Alert(toast);
                bsAlert.close();
            }
        }, 5000);
    }

    function loadChatHistory() {
        // Load chat history from session storage or server
        const history = sessionStorage.getItem('chatHistory');
        if (history) {
            try {
                const messages = JSON.parse(history);
                messages.forEach(msg => {
                    if (msg.type && msg.content) {
                        addMessage(msg.content, msg.type);
                    }
                });
            } catch (e) {
                console.warn('Failed to load chat history:', e);
            }
        }
    }

    function showSafetyDashboard() {
        {% if current_user.is_authenticated and current_user.is_admin %}
        const modal = new bootstrap.Modal(document.getElementById('safetyDashboardModal'));
        modal.show();
        {% else %}
        alert('Safety dashboard is available to administrators only.');
        {% endif %}
    }

    function getSessionId() {
        let sessionId = sessionStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('sessionId', sessionId);
        }
        return sessionId;
    }

    function getCSRFToken() {
        return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }

    // Make some functions globally available
    window.showSafetyDashboard = showSafetyDashboard;

})();
</script>

<style>
/* Chat Interface Styles */
.chat-container {
    height: 400px;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(0,0,0,0.3);
    border-radius: 0.5rem;
}

.message {
    margin-bottom: 1rem;
}

.avatar {
    width: 40px;
    height: 40px;
    font-size: 1.1rem;
}

.message-content {
    flex: 1;
    max-width: calc(100% - 60px);
}

.message-text {
    word-wrap: break-word;
    line-height: 1.5;
}

.user-message .message-text {
    margin-left: auto;
    max-width: 80%;
}

.safety-info {
    font-size: 0.75rem;
    opacity: 0.7;
}

/* Responsive Design */
@media (max-width: 768px) {
    .avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
    
    .message-content {
        max-width: calc(100% - 50px);
    }
    
    .chat-container {
        height: 300px;
    }
}

/* Safety Status Indicator Animation */
#safetyStatusIndicator i {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Gradient Background for Premium CTA */
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
}
</style>
{% endblock %}