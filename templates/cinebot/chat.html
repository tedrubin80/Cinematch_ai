{% extends "base.html" %}

{% block title %}CineBot - Movie Recommendations - Cinematch{% endblock %}

{% block extra_head %}
<!-- Force CSS refresh with timestamp -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-buster" content="1756607441">
<style>
    /* CACHE BUSTER: 1756607441 */
    /* Modern Claude-inspired Design System */
    :root {
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --bg-sidebar: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --accent-orange: #ea580c;
        --accent-blue: #2563eb;
        --border-light: #e2e8f0;
        --border-medium: #cbd5e0;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --radius: 12px;
    }
    
    body {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segue UI', 'Roboto', sans-serif !important;
    }
    
    .chat-container {
        height: calc(100vh - 160px);
        display: flex;
        flex-direction: column;
        background: var(--bg-primary);
        flex: 1;
    }
    
    .message-area {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        background: var(--bg-primary);
        scroll-behavior: smooth;
    }
    
    .message {
        margin-bottom: 1.5rem;
        animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: #1e293b !important;
        color: #ffffff !important;
        padding: 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
    }
    
    @keyframes messageSlideIn {
        from { 
            opacity: 0; 
            transform: translateY(20px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }
    
    .user-message {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 2rem;
    }
    
    .user-message .message-bubble {
        background: #4a5568 !important;
        color: #ffffff !important;
        padding: 1rem 1.25rem;
        border-radius: 16px 16px 4px 16px;
        max-width: 75%;
        font-size: 0.95rem;
        line-height: 1.5;
        font-weight: 500;
        box-shadow: var(--shadow-md);
        word-wrap: break-word;
    }
    
    .bot-message {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 2rem;
    }
    
    .bot-message .message-bubble {
        background: #2d3748 !important;
        color: #ffffff !important;
        padding: 1.25rem 1.5rem;
        border-radius: 16px 16px 16px 4px;
        max-width: 85%;
        border: 1px solid #4a5568;
        box-shadow: var(--shadow-md);
        font-size: 0.95rem;
        line-height: 1.6;
        font-weight: 400;
        word-wrap: break-word;
    }
    
    .movie-recommendations {
        margin-top: 1rem;
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    
    .movie-card {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        border: 1px solid #4a5568;
        border-radius: 0.75rem;
        padding: 1rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }
    
    .movie-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        border-color: #dc2626;
    }
    
    .input-area {
        padding: 1rem;
        background: #1f2937;
        border-top: 1px solid #374151;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        color: #9ca3af;
        font-style: italic;
        margin-bottom: 1rem;
    }
    
    .typing-dots {
        display: inline-block;
        margin-left: 0.5rem;
    }
    
    .typing-dots span {
        display: inline-block;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background-color: #9ca3af;
        margin: 0 1px;
        animation: typingBounce 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typingBounce {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    /* Flex Container */
    .flex {
        display: flex !important;
    }
    
    .h-screen {
        min-height: calc(100vh - 80px) !important;
    }
    
    /* Modern Sidebar Design */
    .mood-sidebar {
        width: 320px !important;
        min-width: 320px !important;
        background: var(--bg-sidebar) !important;
        border-right: 1px solid var(--border-light) !important;
        overflow-y: auto !important;
        display: block !important;
        position: relative !important;
        flex-shrink: 0;
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-lg);
    }
    
    .mood-sidebar.collapsed {
        width: 0;
        min-width: 0;
        overflow: hidden;
        border-right: none;
    }
    
    .mood-sidebar-header {
        padding: 2rem 1.5rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
        background: linear-gradient(135deg, var(--accent-orange), #f97316);
        color: white;
    }
    
    .mood-sidebar-title {
        display: flex;
        align-items: center;
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        gap: 0.75rem;
        color: white;
    }
    
    .mood-icon {
        font-size: 1.5rem;
    }
    
    .mood-sidebar-subtitle {
        font-size: 0.9rem;
        font-weight: 500;
        margin: 0;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .mood-options {
        padding: 1.5rem;
    }
    
    .mood-category {
        margin-bottom: 2rem;
    }
    
    .mood-category-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
        padding-left: 0.5rem;
    }
    
    .adult-only {
        border-top: 1px solid var(--border-light);
        padding-top: 1.5rem;
    }
    
    .mood-button {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0.875rem 1rem;
        margin-bottom: 0.5rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.875rem;
        font-weight: 500;
        text-align: left;
        gap: 0.75rem;
    }
    
    .mood-button:hover {
        background: var(--bg-primary);
        border-color: var(--accent-orange);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .mood-button:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
    }
    
    .mood-emoji {
        font-size: 1.25rem;
        flex-shrink: 0;
    }
    
    .mood-text {
        flex: 1;
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    .mood-custom {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-light);
    }
    
    .mood-custom-label {
        color: var(--text-muted);
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.75rem;
    }
    
    .mood-custom-input {
        width: 100%;
        padding: 0.75rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-medium);
        border-radius: var(--radius);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .mood-custom-input:focus {
        outline: none;
        border-color: var(--accent-orange);
        box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
    }
    
    .mood-custom-input::placeholder {
        color: var(--text-muted);
    }
    
    .sidebar-toggle {
        position: absolute;
        top: 50%;
        right: -12px;
        width: 24px;
        height: 48px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-medium);
        border-radius: 0 var(--radius) var(--radius) 0;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 10;
        font-size: 0.75rem;
        transform: translateY(-50%);
        box-shadow: var(--shadow-md);
    }
    
    .sidebar-toggle:hover {
        background: var(--accent-orange);
        color: white;
        border-color: var(--accent-orange);
    }
    
    .sidebar-toggle i {
        transition: transform 0.2s ease;
    }
    
    .mood-sidebar.collapsed .sidebar-toggle i {
        transform: rotate(180deg);
    }
    
    /* Header and Input Area Styling */
    .bg-gray-800 {
        background: var(--bg-secondary) !important;
        border-bottom: 1px solid var(--border-light) !important;
        box-shadow: var(--shadow-sm) !important;
    }
    
    .input-area {
        padding: 1.5rem 2rem;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-light);
        box-shadow: var(--shadow-lg);
    }
    
    .input-area input {
        background: var(--bg-primary) !important;
        border: 1px solid var(--border-medium) !important;
        color: var(--text-primary) !important;
        border-radius: var(--radius) !important;
        padding: 0.875rem 1rem !important;
        font-size: 0.95rem !important;
        transition: all 0.2s ease !important;
    }
    
    .input-area input:focus {
        outline: none !important;
        border-color: var(--accent-orange) !important;
        box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1) !important;
    }
    
    .input-area input::placeholder {
        color: var(--text-muted) !important;
    }
    
    .input-area button {
        background: var(--accent-orange) !important;
        border: none !important;
        color: white !important;
        border-radius: var(--radius) !important;
        padding: 0.875rem 1.5rem !important;
        font-weight: 600 !important;
        transition: all 0.2s ease !important;
        box-shadow: var(--shadow-md) !important;
    }
    
    .input-area button:hover:not(:disabled) {
        background: #c2410c !important;
        transform: translateY(-1px) !important;
        box-shadow: var(--shadow-lg) !important;
    }
    
    .input-area button:disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
    }
    
    .content-filter-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 0.875rem;
        border-radius: 2rem;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid var(--border-light);
        background: var(--bg-secondary);
        box-shadow: var(--shadow-sm);
    }
    
    .teen-mode {
        color: #059669;
        border-color: #a7f3d0;
        background: #ecfdf5;
    }
    
    .adult-mode {
        color: var(--accent-orange);
        border-color: #fed7aa;
        background: #fff7ed;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        padding: 1rem 2rem;
        color: var(--text-muted);
        font-style: italic;
        background: var(--bg-secondary);
        margin-bottom: 0.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
    }
</style>
{% endblock %}

{% block content %}
<div class="relative min-h-screen" style="background: var(--bg-primary)">
    <!-- Content Filter Badge -->
    <div class="content-filter-badge {{ 'teen-mode' if user.content_filter_level == 'teen' else 'adult-mode' }}">
        <i class="fas fa-shield-alt mr-1"></i>
        {{ 'Teen Mode' if user.content_filter_level == 'teen' else 'Adult Mode' }}
    </div>
    
    <!-- Header -->
    <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="text-4xl">üé¨</div>
                <div>
                    <h1 class="text-2xl font-bold" style="background: linear-gradient(135deg, var(--accent-orange), #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        CineBot
                    </h1>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">AI Movie Recommendation Assistant</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="clearChat" style="color: var(--text-muted); transition: all 0.2s;" title="Clear Chat" onmouseover="this.style.color='var(--accent-orange)'" onmouseout="this.style.color='var(--text-muted)'">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="settingsBtn" style="color: var(--text-muted); transition: all 0.2s;" title="Settings" onmouseover="this.style.color='var(--accent-orange)'" onmouseout="this.style.color='var(--text-muted)'">
                    <i class="fas fa-cog"></i>
                </button>
                <a href="{{ url_for('index') }}" style="color: var(--text-muted); transition: all 0.2s;" title="Back to Home" onmouseover="this.style.color='var(--accent-orange)'" onmouseout="this.style.color='var(--text-muted)'">
                    <i class="fas fa-home"></i>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Container with Sidebar -->
    <div class="flex h-screen" style="display: flex !important; min-height: calc(100vh - 80px) !important;">
        <!-- Mood Sidebar -->
        <div id="moodSidebar" class="mood-sidebar">
            <div class="mood-sidebar-header">
                <h3 class="mood-sidebar-title">
                    <span class="mood-icon">üé≠</span>
                    Find Your Perfect Movie
                </h3>
                <p class="mood-sidebar-subtitle">What describes you right now?</p>
            </div>
            
            <div class="mood-options">
                <!-- Universal Mood Options -->
                <div class="mood-category">
                    <div class="mood-button" data-mood="happy">
                        <span class="mood-emoji">üòÑ</span>
                        <span class="mood-text">Need a good laugh</span>
                    </div>
                    <div class="mood-button" data-mood="sad">
                        <span class="mood-emoji">üò≠</span>
                        <span class="mood-text">Want to cry it out</span>
                    </div>
                    <div class="mood-button" data-mood="adventurous">
                        <span class="mood-emoji">üó∫Ô∏è</span>
                        <span class="mood-text">Craving adventure</span>
                    </div>
                    <div class="mood-button" data-mood="inspiring">
                        <span class="mood-emoji">‚ú®</span>
                        <span class="mood-text">Need inspiration</span>
                    </div>
                    <div class="mood-button" data-mood="romantic">
                        <span class="mood-emoji">üíï</span>
                        <span class="mood-text">Looking for romance</span>
                    </div>
                    <div class="mood-button" data-mood="thoughtful">
                        <span class="mood-emoji">üß†</span>
                        <span class="mood-text">Want mind-bending sci-fi</span>
                    </div>
                    <div class="mood-button" data-mood="comfort">
                        <span class="mood-emoji">üõãÔ∏è</span>
                        <span class="mood-text">Need comfort food cinema</span>
                    </div>
                </div>
                
                <!-- 18+ Options (shown only for adult users) -->
                {% if user.content_filter_level == 'adult' %}
                <div class="mood-category adult-only">
                    <div class="mood-category-label">
                        <i class="fas fa-exclamation-triangle text-orange-400"></i>
                        <span>18+ Content</span>
                    </div>
                    <div class="mood-button" data-mood="scary">
                        <span class="mood-emoji">üëª</span>
                        <span class="mood-text">Want to be scared</span>
                    </div>
                    <div class="mood-button" data-mood="violent">
                        <span class="mood-emoji">üî•</span>
                        <span class="mood-text">Classic action/violence</span>
                    </div>
                </div>
                {% endif %}
                
                <!-- Custom Input -->
                <div class="mood-custom">
                    <p class="mood-custom-label">Or describe your mood:</p>
                    <input type="text" 
                           id="customMoodInput" 
                           placeholder="Tell me how you're feeling..."
                           class="mood-custom-input">
                </div>
            </div>
            
            <!-- Toggle Button -->
            <button id="sidebarToggle" class="sidebar-toggle" title="Hide/Show Mood Selector">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <!-- Chat Container -->
        <div class="chat-container">
            <!-- Messages Area -->
            <div id="messageArea" class="message-area">
            <!-- Welcome message will be inserted here -->
            <div class="text-center py-8">
                <div class="text-6xl mb-4">üçø</div>
                <h2 class="text-xl font-semibold mb-2">Welcome to CineBot!</h2>
                <p class="text-gray-400">Starting your personalized movie recommendation session...</p>
            </div>
        </div>
        
        <!-- Typing Indicator -->
        <div id="typingIndicator" class="typing-indicator">
            <div class="text-lg mr-2">ü§ñ</div>
            <span>CineBot is thinking</span>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="input-area">
            <!-- Message Input -->
            <div class="flex space-x-4">
                <input type="text" 
                       id="messageInput" 
                       placeholder="Tell me what kind of movie you're in the mood for..."
                       class="flex-1 p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-red-500 focus:outline-none"
                       disabled>
                <button id="sendButton" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition duration-200 disabled:opacity-50"
                        disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                <span>Press Enter to send</span>
                <span id="sessionStatus">Initializing...</span>
            </div>
        </div>
    </div>
    </div> <!-- Close flex container -->
</div>

<!-- Movie Details Modal -->
<div id="movieModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-gray-800 rounded-lg max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-start mb-4">
                <h2 id="movieTitle" class="text-2xl font-bold"></h2>
                <button id="closeModal" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="movieDetails">
                <!-- Movie details will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
class CineBot {
    constructor() {
        this.sessionId = null;
        this.messageArea = document.getElementById('messageArea');
        this.messageInput = document.getElementById('messageInput');
        this.sendButton = document.getElementById('sendButton');
        this.typingIndicator = document.getElementById('typingIndicator');
        this.moodSidebar = document.getElementById('moodSidebar');
        this.sessionStatus = document.getElementById('sessionStatus');
        this.customMoodInput = document.getElementById('customMoodInput');
        
        this.initializeEventListeners();
        this.startSession();
    }
    
    initializeEventListeners() {
        // Send message on button click
        this.sendButton.addEventListener('click', () => this.sendMessage());
        
        // Send message on Enter key
        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // Mood selector buttons
        document.querySelectorAll('.mood-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const mood = e.currentTarget.dataset.mood;
                this.sendMoodMessage(mood);
            });
        });
        
        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            this.toggleSidebar();
        });
        
        // Custom mood input
        this.customMoodInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                this.sendCustomMoodMessage(e.target.value.trim());
                e.target.value = '';
            }
        });
        
        // Clear chat
        document.getElementById('clearChat').addEventListener('click', () => {
            this.clearChat();
        });
        
        // Close modal
        document.getElementById('closeModal').addEventListener('click', () => {
            this.hideMovieModal();
        });
        
        // Close modal on background click
        document.getElementById('movieModal').addEventListener('click', (e) => {
            if (e.target.id === 'movieModal') {
                this.hideMovieModal();
            }
        });
    }
    
    async startSession() {
        try {
            this.sessionStatus.textContent = 'Starting session...';
            
            const response = await fetch('/cinebot/api/start-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_type: 'general'
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.sessionId = data.session_id;
                this.addBotMessage(data.greeting);
                this.messageInput.disabled = false;
                this.sendButton.disabled = false;
                this.messageInput.focus();
                this.sessionStatus.textContent = 'Connected';
            } else {
                this.addErrorMessage('Failed to start session: ' + (data.error || 'Unknown error'));
                if (data.redirect) {
                    window.location.href = data.redirect;
                }
            }
        } catch (error) {
            console.error('Error starting session:', error);
            this.addErrorMessage('Failed to connect to CineBot. Please refresh the page.');
        }
    }
    
    async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message || !this.sessionId) return;
        
        // Add user message to chat
        this.addUserMessage(message);
        this.messageInput.value = '';
        
        // Show typing indicator
        this.showTypingIndicator();
        
        try {
            const response = await fetch('/cinebot/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: this.sessionId,
                    message: message
                })
            });
            
            const data = await response.json();
            
            this.hideTypingIndicator();
            
            if (data.success) {
                this.addBotMessage(data.message);
                
                if (data.recommendations && data.recommendations.length > 0) {
                    this.addMovieRecommendations(data.recommendations);
                }
            } else {
                this.addErrorMessage('Error: ' + (data.error || 'Failed to get response'));
            }
        } catch (error) {
            this.hideTypingIndicator();
            console.error('Error sending message:', error);
            this.addErrorMessage('Failed to send message. Please try again.');
        }
    }
    
    sendMoodMessage(mood) {
        const moodMessages = {
            'happy': "I need a good laugh! Show me some fun, comedy movies that will make me smile.",
            'sad': "I want to cry it out. Please recommend some emotional movies that will help me feel better.",
            'adventurous': "I'm craving adventure! Show me epic movies with quests, journeys, and exciting action.",
            'inspiring': "I need inspiration right now. Please find me uplifting movies that will motivate me.",
            'romantic': "I'm looking for romance. Show me beautiful love stories that will warm my heart.",
            'thoughtful': "I want mind-bending sci-fi! Give me movies that will make me think and question reality.",
            'comfort': "I need comfort food cinema. Show me cozy, feel-good movies that are like a warm hug.",
            'scary': "I want to be scared! Recommend some truly frightening horror movies that will give me chills.",
            'violent': "I'm in the mood for classic action with violence. Show me intense action movies with great fight scenes."
        };
        
        const message = moodMessages[mood] || `I'm feeling ${mood}`;
        this.messageInput.value = message;
        this.sendMessage();
    }
    
    sendCustomMoodMessage(customMood) {
        const message = `I'm feeling ${customMood}. Can you recommend movies that match this mood?`;
        this.messageInput.value = message;
        this.sendMessage();
    }
    
    toggleSidebar() {
        this.moodSidebar.classList.toggle('collapsed');
    }
    
    addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${this.escapeHtml(message)}
            </div>
        `;
        
        this.messageArea.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    addBotMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="text-2xl">ü§ñ</div>
                <div class="message-bubble">
                    ${this.formatBotMessage(message)}
                </div>
            </div>
        `;
        
        this.messageArea.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    addMovieRecommendations(recommendations) {
        const recommendationsDiv = document.createElement('div');
        recommendationsDiv.className = 'message bot-message';
        
        let moviesHtml = '<div class="movie-recommendations">';
        
        recommendations.forEach(movie => {
            moviesHtml += `
                <div class="movie-card" onclick="cinebot.showMovieDetails(${JSON.stringify(movie).replace(/"/g, '&quot;')})">
                    ${movie.poster_path ? `<img src="${movie.poster_path}" alt="${movie.title}" class="w-full h-48 object-cover rounded-lg mb-3">` : ''}
                    <h3 class="font-bold text-lg mb-2">${movie.title}</h3>
                    ${movie.rating ? `<span class="inline-block bg-yellow-600 text-white text-xs px-2 py-1 rounded mb-2">${movie.rating}</span>` : ''}
                    <p class="text-gray-300 text-sm line-clamp-3">${movie.overview || 'No description available.'}</p>
                    <div class="flex justify-between items-center mt-3">
                        <button onclick="event.stopPropagation(); cinebot.recordInteraction('${movie.tmdb_id}', 'liked')" class="text-green-400 hover:text-green-300">
                            <i class="fas fa-thumbs-up"></i>
                        </button>
                        <button onclick="event.stopPropagation(); cinebot.recordInteraction('${movie.tmdb_id}', 'disliked')" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-thumbs-down"></i>
                        </button>
                        <button onclick="event.stopPropagation(); cinebot.recordInteraction('${movie.tmdb_id}', 'saved')" class="text-blue-400 hover:text-blue-300">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        moviesHtml += '</div>';
        recommendationsDiv.innerHTML = moviesHtml;
        
        this.messageArea.appendChild(recommendationsDiv);
        this.scrollToBottom();
    }
    
    addErrorMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.innerHTML = `
            <div class="bg-red-600 bg-opacity-20 border border-red-600 rounded-lg p-3">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span class="text-red-400">${this.escapeHtml(message)}</span>
            </div>
        `;
        
        this.messageArea.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    showTypingIndicator() {
        this.typingIndicator.style.display = 'flex';
        this.scrollToBottom();
    }
    
    hideTypingIndicator() {
        this.typingIndicator.style.display = 'none';
    }
    
    showMovieDetails(movie) {
        document.getElementById('movieTitle').textContent = movie.title;
        
        let detailsHtml = '';
        
        if (movie.poster_path) {
            detailsHtml += `<img src="${movie.poster_path}" alt="${movie.title}" class="float-right ml-4 mb-4 w-48 rounded-lg">`;
        }
        
        if (movie.overview) {
            detailsHtml += `<p class="mb-4">${movie.overview}</p>`;
        }
        
        if (movie.rating) {
            detailsHtml += `<p class="mb-2"><strong>Rating:</strong> ${movie.rating}</p>`;
        }
        
        if (movie.genres && movie.genres.length > 0) {
            detailsHtml += `<p class="mb-2"><strong>Genres:</strong> ${movie.genres.join(', ')}</p>`;
        }
        
        if (movie.director) {
            detailsHtml += `<p class="mb-2"><strong>Director:</strong> ${movie.director}</p>`;
        }
        
        if (movie.main_cast && movie.main_cast.length > 0) {
            detailsHtml += `<p class="mb-4"><strong>Cast:</strong> ${movie.main_cast.slice(0, 5).join(', ')}</p>`;
        }
        
        detailsHtml += `
            <div class="flex space-x-4 mt-6">
                <button onclick="cinebot.recordInteraction('${movie.tmdb_id}', 'liked')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-thumbs-up mr-2"></i>Like
                </button>
                <button onclick="cinebot.recordInteraction('${movie.tmdb_id}', 'saved')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-bookmark mr-2"></i>Save for Later
                </button>
                <button onclick="cinebot.recordInteraction('${movie.tmdb_id}', 'watched')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-eye mr-2"></i>Mark as Watched
                </button>
            </div>
        `;
        
        document.getElementById('movieDetails').innerHTML = detailsHtml;
        document.getElementById('movieModal').style.display = 'flex';
    }
    
    hideMovieModal() {
        document.getElementById('movieModal').style.display = 'none';
    }
    
    async recordInteraction(movieId, interactionType) {
        try {
            const response = await fetch('/cinebot/api/movie-interaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: this.sessionId,
                    movie: { tmdb_id: movieId },
                    interaction_type: interactionType
                })
            });
            
            const data = await response.json();
            if (data.success) {
                // Show brief confirmation
                console.log('Interaction recorded:', interactionType);
            }
        } catch (error) {
            console.error('Error recording interaction:', error);
        }
    }
    
    clearChat() {
        if (confirm('Clear chat history? This will start a new session.')) {
            this.messageArea.innerHTML = '';
            this.startSession();
        }
    }
    
    formatBotMessage(message) {
        return message.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    scrollToBottom() {
        this.messageArea.scrollTop = this.messageArea.scrollHeight;
    }
}

// Initialize CineBot when page loads
let cinebot;
document.addEventListener('DOMContentLoaded', () => {
    // Force style refresh
    document.body.style.background = '#f8fafc';
    document.body.style.color = '#1e293b';
    
    // Force update all elements
    const elements = document.querySelectorAll('*');
    elements.forEach(el => {
        if (el.style) {
            el.style.display = el.style.display;
        }
    });
    
    cinebot = new CineBot();
});
</script>
{% endblock %}