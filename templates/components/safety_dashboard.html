<!-- Safety Dashboard Component -->
<div id="safetyDashboard" class="container-fluid">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="fw-bold mb-0">
                    <i class="fas fa-shield-alt me-2 text-primary"></i>
                    Safety Dashboard
                </h4>
                <div class="d-flex gap-2">
                    <select id="timeRangeSelector" class="form-select form-select-sm" style="width: auto;">
                        <option value="24">Last 24 Hours</option>
                        <option value="168">Last 7 Days</option>
                        <option value="720">Last 30 Days</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="refreshDashboard">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div id="systemStatusIndicator" class="status-indicator me-3">
                                    <!-- Status indicator will be populated by JavaScript -->
                                </div>
                                <div>
                                    <h6 class="mb-1 fw-bold">System Status</h6>
                                    <p class="mb-0 text-muted" id="systemStatusText">
                                        All safety systems operational
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="d-flex align-items-center justify-content-md-end">
                                <div class="me-3">
                                    <small class="text-muted">Compliance Score</small>
                                    <div class="fw-bold fs-4 text-success" id="complianceScore">98.5%</div>
                                </div>
                                <div class="compliance-gauge">
                                    <canvas id="complianceGauge" width="60" height="60"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Cards Row -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon mb-3">
                        <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1" id="totalViolations">0</h3>
                    <p class="text-muted mb-0">Total Violations</p>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-warning" id="violationsTrend" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon mb-3">
                        <i class="fas fa-user-slash text-danger fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1" id="blockedUsers">0</h3>
                    <p class="text-muted mb-0">Blocked Users</p>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-danger" id="blockedUsersTrend" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon mb-3">
                        <i class="fas fa-bell text-info fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1" id="activeWarnings">0</h3>
                    <p class="text-muted mb-0">Active Warnings</p>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-info" id="warningsTrend" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="metric-icon mb-3">
                        <i class="fas fa-chart-line text-success fa-2x"></i>
                    </div>
                    <h3 class="fw-bold mb-1" id="totalEvents">0</h3>
                    <p class="text-muted mb-0">Total Events</p>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-success" id="eventsTrend" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-area me-2"></i>
                        Safety Events Timeline
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="safetyTimelineChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-pie me-2"></i>
                        Violations by Type
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="violationTypesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Events and Alerts Row -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-list me-2"></i>
                        Recent Safety Events
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div id="recentEventsList" class="list-group list-group-flush">
                        <!-- Recent events will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Active Alerts
                    </h6>
                </div>
                <div class="card-body">
                    <div id="activeAlertsList">
                        <!-- Active alerts will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-analytics me-2"></i>
                        Safety Analytics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="safetyAnalyticsTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Current Period</th>
                                    <th>Previous Period</th>
                                    <th>Change</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Analytics data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Safety Dashboard JavaScript
(function() {
    'use strict';

    let dashboardData = null;
    let timelineChart = null;
    let violationTypesChart = null;
    let refreshInterval = null;

    document.addEventListener('DOMContentLoaded', function() {
        initializeSafetyDashboard();
        setupEventListeners();
        startAutoRefresh();
    });

    function initializeSafetyDashboard() {
        loadDashboardData();
    }

    function setupEventListeners() {
        document.getElementById('timeRangeSelector').addEventListener('change', loadDashboardData);
        document.getElementById('refreshDashboard').addEventListener('click', loadDashboardData);
    }

    function startAutoRefresh() {
        // Refresh every 30 seconds
        refreshInterval = setInterval(loadDashboardData, 30000);
    }

    function loadDashboardData() {
        const timeRange = document.getElementById('timeRangeSelector').value;
        const refreshBtn = document.getElementById('refreshDashboard');
        
        // Show loading state
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        refreshBtn.disabled = true;

        fetch(`/api/safety/dashboard?hours=${timeRange}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                dashboardData = data;
                updateDashboard(data);
            } else {
                showError('Failed to load dashboard data: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
            showError('Failed to load dashboard data');
        })
        .finally(() => {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            refreshBtn.disabled = false;
        });
    }

    function updateDashboard(data) {
        updateSystemStatus(data.system_status);
        updateMetricCards(data.metrics);
        updateCharts(data.metrics);
        updateRecentEvents(data.recent_events);
        updateActiveAlerts(data.active_alerts);
        updateAnalyticsTable(data.metrics);
    }

    function updateSystemStatus(systemStatus) {
        const statusIndicator = document.getElementById('systemStatusIndicator');
        const statusText = document.getElementById('systemStatusText');
        const complianceScore = document.getElementById('complianceScore');

        // Update status indicator
        const statusConfig = {
            'healthy': { color: 'success', icon: 'fas fa-check-circle', text: 'All systems operational' },
            'warning': { color: 'warning', icon: 'fas fa-exclamation-triangle', text: 'Some issues detected' },
            'critical': { color: 'danger', icon: 'fas fa-times-circle', text: 'Critical issues require attention' }
        };

        const config = statusConfig[systemStatus.status] || statusConfig.healthy;
        
        statusIndicator.innerHTML = `
            <div class="d-flex align-items-center justify-content-center rounded-circle bg-${config.color} text-white" 
                 style="width: 50px; height: 50px;">
                <i class="${config.icon}"></i>
            </div>
        `;

        statusText.textContent = config.text;
        complianceScore.textContent = (systemStatus.compliance_score * 100).toFixed(1) + '%';

        // Update compliance gauge
        updateComplianceGauge(systemStatus.compliance_score);
    }

    function updateComplianceGauge(score) {
        const canvas = document.getElementById('complianceGauge');
        const ctx = canvas.getContext('2d');
        const centerX = 30;
        const centerY = 30;
        const radius = 25;

        ctx.clearRect(0, 0, 60, 60);

        // Background circle
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = '#e9ecef';
        ctx.lineWidth = 4;
        ctx.stroke();

        // Progress arc
        const startAngle = -Math.PI / 2;
        const endAngle = startAngle + (2 * Math.PI * score);

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.strokeStyle = score > 0.9 ? '#28a745' : score > 0.8 ? '#ffc107' : '#dc3545';
        ctx.lineWidth = 4;
        ctx.stroke();
    }

    function updateMetricCards(metrics) {
        document.getElementById('totalViolations').textContent = metrics.total_events || 0;
        document.getElementById('blockedUsers').textContent = metrics.blocked_users || 0;
        document.getElementById('activeWarnings').textContent = metrics.active_warnings || 0;
        document.getElementById('totalEvents').textContent = metrics.total_events || 0;

        // Update trend indicators (simplified)
        updateTrendIndicator('violationsTrend', 25);
        updateTrendIndicator('blockedUsersTrend', 10);
        updateTrendIndicator('warningsTrend', 40);
        updateTrendIndicator('eventsTrend', 60);
    }

    function updateTrendIndicator(elementId, percentage) {
        document.getElementById(elementId).style.width = percentage + '%';
    }

    function updateCharts(metrics) {
        updateTimelineChart(metrics.trend_data);
        updateViolationTypesChart(metrics.violations_by_type);
    }

    function updateTimelineChart(trendData) {
        const ctx = document.getElementById('safetyTimelineChart').getContext('2d');

        if (timelineChart) {
            timelineChart.destroy();
        }

        const labels = trendData.timestamps || [];
        const criticalData = trendData.critical || [];
        const highData = trendData.high || [];
        const mediumData = trendData.medium || [];
        const lowData = trendData.low || [];

        timelineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels.map(label => new Date(label).toLocaleTimeString()),
                datasets: [
                    {
                        label: 'Critical',
                        data: criticalData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'High',
                        data: highData,
                        borderColor: '#fd7e14',
                        backgroundColor: 'rgba(253, 126, 20, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Medium',
                        data: mediumData,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Low',
                        data: lowData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function updateViolationTypesChart(violationTypes) {
        const ctx = document.getElementById('violationTypesChart').getContext('2d');

        if (violationTypesChart) {
            violationTypesChart.destroy();
        }

        const labels = Object.keys(violationTypes || {});
        const data = Object.values(violationTypes || {});
        const colors = [
            '#dc3545', '#fd7e14', '#ffc107', '#28a745', 
            '#17a2b8', '#6f42c1', '#e83e8c', '#20c997'
        ];

        violationTypesChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels.map(label => label.replace('_', ' ').toUpperCase()),
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function updateRecentEvents(events) {
        const eventsList = document.getElementById('recentEventsList');
        
        if (!events || events.length === 0) {
            eventsList.innerHTML = `
                <div class="list-group-item text-center text-muted py-4">
                    <i class="fas fa-info-circle me-2"></i>
                    No recent events
                </div>
            `;
            return;
        }

        eventsList.innerHTML = events.slice(0, 10).map(event => {
            const severityConfig = {
                'critical': { color: 'danger', icon: 'fas fa-times-circle' },
                'high': { color: 'warning', icon: 'fas fa-exclamation-triangle' },
                'medium': { color: 'info', icon: 'fas fa-info-circle' },
                'low': { color: 'secondary', icon: 'fas fa-circle-info' }
            };

            const config = severityConfig[event.severity] || severityConfig.low;
            const timestamp = new Date(event.timestamp).toLocaleString();

            return `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-start">
                            <i class="${config.icon} text-${config.color} me-3 mt-1"></i>
                            <div>
                                <h6 class="mb-1">${event.event_type.replace('_', ' ').toUpperCase()}</h6>
                                <p class="mb-1 text-muted small">${event.source}</p>
                                <small class="text-muted">${timestamp}</small>
                            </div>
                        </div>
                        <span class="badge bg-${config.color}">${event.severity}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateActiveAlerts(alerts) {
        const alertsList = document.getElementById('activeAlertsList');
        
        if (!alerts || alerts.length === 0) {
            alertsList.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-check-circle me-2"></i>
                    No active alerts
                </div>
            `;
            return;
        }

        alertsList.innerHTML = alerts.map(alert => `
            <div class="alert alert-${alert.severity} border-0 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>${alert.title}</strong>
                        <p class="mb-0 mt-1">${alert.message}</p>
                    </div>
                    <button type="button" class="btn-close" onclick="dismissAlert('${alert.id}')"></button>
                </div>
            </div>
        `).join('');
    }

    function updateAnalyticsTable(metrics) {
        const tableBody = document.querySelector('#safetyAnalyticsTable tbody');
        
        const analyticsData = [
            {
                metric: 'Total Violations',
                current: metrics.total_events || 0,
                previous: Math.floor((metrics.total_events || 0) * 0.8),
                format: 'number'
            },
            {
                metric: 'Compliance Score',
                current: (metrics.compliance_score || 0) * 100,
                previous: ((metrics.compliance_score || 0) * 100) - 2,
                format: 'percentage'
            },
            {
                metric: 'Blocked Users',
                current: metrics.blocked_users || 0,
                previous: Math.floor((metrics.blocked_users || 0) * 1.2),
                format: 'number'
            },
            {
                metric: 'Active Warnings',
                current: metrics.active_warnings || 0,
                previous: Math.floor((metrics.active_warnings || 0) * 1.1),
                format: 'number'
            }
        ];

        tableBody.innerHTML = analyticsData.map(item => {
            const change = item.current - item.previous;
            const changePercent = item.previous === 0 ? 0 : (change / item.previous) * 100;
            const isPositive = change > 0;
            const isImprovement = (item.metric === 'Compliance Score' && isPositive) || 
                                 (item.metric !== 'Compliance Score' && !isPositive);

            const formatValue = (value) => {
                if (item.format === 'percentage') {
                    return value.toFixed(1) + '%';
                }
                return value.toString();
            };

            return `
                <tr>
                    <td class="fw-bold">${item.metric}</td>
                    <td>${formatValue(item.current)}</td>
                    <td>${formatValue(item.previous)}</td>
                    <td>
                        <span class="badge bg-${isImprovement ? 'success' : 'danger'}">
                            <i class="fas fa-arrow-${isPositive ? 'up' : 'down'} me-1"></i>
                            ${Math.abs(changePercent).toFixed(1)}%
                        </span>
                    </td>
                    <td>
                        <div class="trend-indicator">
                            <i class="fas fa-chart-line text-${isImprovement ? 'success' : 'danger'}"></i>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getCSRFToken() {
        return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }

    function showError(message) {
        // Show error toast
        const toast = document.createElement('div');
        toast.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) {
                const bsAlert = new bootstrap.Alert(toast);
                bsAlert.close();
            }
        }, 5000);
    }

    // Global functions
    window.dismissAlert = function(alertId) {
        // Implementation for dismissing alerts
        console.log('Dismissing alert:', alertId);
    };

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });

})();
</script>

<style>
/* Safety Dashboard Styles */
#safetyDashboard .status-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

#safetyDashboard .metric-icon {
    opacity: 0.8;
    transition: opacity 0.3s ease;
}

#safetyDashboard .card:hover .metric-icon {
    opacity: 1;
}

#safetyDashboard .progress {
    background-color: rgba(0,0,0,0.1);
}

#safetyDashboard .list-group-item:hover {
    background-color: rgba(0,123,255,0.05);
}

#safetyDashboard .trend-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
}

#safetyDashboard .table th {
    border-top: none;
    font-weight: 600;
    color: #6c757d;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

#safetyDashboard .alert {
    border-radius: 0.5rem;
}

#safetyDashboard .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#safetyDashboard .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

@media (max-width: 768px) {
    #safetyDashboard .row {
        margin-left: 0;
        margin-right: 0;
    }
    
    #safetyDashboard .col-lg-3,
    #safetyDashboard .col-lg-4,
    #safetyDashboard .col-lg-6,
    #safetyDashboard .col-lg-8 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }
}
</style>