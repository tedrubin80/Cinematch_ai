{% extends "base.html" %}

{% block title %}Create Route - Cinematch Admin{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include 'admin/nav.html' %}
    
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h2 class="text-3xl font-bold mb-8">Create New Route</h2>
        
        <form id="createRouteForm" class="space-y-6">
            <!-- Basic Information -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Basic Information</h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-2">Route Name</label>
                        <input type="text" name="name" required
                               class="w-full p-2 rounded bg-gray-700 text-white"
                               placeholder="My Custom Route">
                    </div>
                    
                    <div>
                        <label class="block mb-2">HTTP Method</label>
                        <select name="method" class="w-full p-2 rounded bg-gray-700 text-white">
                            <option value="GET">GET</option>
                            <option value="POST" selected>POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block mb-2">Route Path</label>
                        <input type="text" name="path" required
                               class="w-full p-2 rounded bg-gray-700 text-white font-mono"
                               placeholder="/api/custom/my-route"
                               pattern="^/[a-zA-Z0-9/_-]+$">
                        <p class="text-xs text-gray-400 mt-1">Must start with / and contain only letters, numbers, -, _</p>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block mb-2">Description</label>
                        <textarea name="description" rows="2"
                                  class="w-full p-2 rounded bg-gray-700 text-white"
                                  placeholder="What does this route do?"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Route Configuration -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Route Configuration</h3>
                
                <div class="mb-4">
                    <label class="block mb-2">Action Type</label>
                    <select name="action_type" onchange="updateActionConfig(this.value)"
                            class="w-full p-2 rounded bg-gray-700 text-white">
                        <option value="llm_query">LLM Query</option>
                        <option value="database_query">Database Query</option>
                        <option value="webhook">Webhook</option>
                        <option value="cache_lookup">Cache Lookup</option>
                    </select>
                </div>
                
                <!-- LLM Configuration (shown by default) -->
                <div id="llm_config" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2">Model</label>
                            <select name="model" class="w-full p-2 rounded bg-gray-700 text-white">
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="gemini">Gemini (Google)</option>
                                <option value="auto">Auto-select</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block mb-2">Response Format</label>
                            <select name="response_format" class="w-full p-2 rounded bg-gray-700 text-white">
                                <option value="json">JSON</option>
                                <option value="text">Plain Text</option>
                                <option value="markdown">Markdown</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block mb-2">Temperature</label>
                            <input type="range" name="temperature" min="0" max="20" value="7"
                                   oninput="document.getElementById('tempValue').textContent = (this.value/10).toFixed(1)">
                            <span id="tempValue">0.7</span>
                        </div>
                        
                        <div>
                            <label class="block mb-2">Top-K</label>
                            <input type="number" name="top_k" value="10" min="1" max="100"
                                   class="w-full p-2 rounded bg-gray-700 text-white">
                        </div>
                        
                        <div>
                            <label class="block mb-2">Max Tokens</label>
                            <input type="number" name="max_tokens" value="150" min="10" max="4000"
                                   class="w-full p-2 rounded bg-gray-700 text-white">
                        </div>
                        
                        <div>
                            <label class="block mb-2">Cache TTL (seconds)</label>
                            <input type="number" name="cache_ttl" value="300" min="0" max="86400"
                                   class="w-full p-2 rounded bg-gray-700 text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block mb-2">System Prompt</label>
                        <textarea name="system_prompt" rows="4"
                                  class="w-full p-2 rounded bg-gray-700 text-white font-mono text-sm"
                                  placeholder="You are a helpful AI assistant..."></textarea>
                    </div>
                </div>
                
                <!-- Other config types (hidden by default) -->
                <div id="database_config" class="hidden">
                    <p class="text-gray-400">Database query configuration coming soon</p>
                </div>
                
                <div id="webhook_config" class="hidden">
                    <p class="text-gray-400">Webhook configuration coming soon</p>
                </div>
            </div>
            
            <!-- Security Settings -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Security Settings</h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="requires_auth" checked class="mr-2">
                            Require Authentication
                        </label>
                    </div>
                    
                    <div>
                        <label class="block mb-2">Rate Limit (per minute)</label>
                        <input type="number" name="rate_limit" value="60" min="1" max="1000"
                               class="w-full p-2 rounded bg-gray-700 text-white">
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded">
                    Create Route
                </button>
                <a href="{{ url_for('admin_routes.manage_routes') }}" 
                   class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded inline-block">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
function updateActionConfig(actionType) {
    // Hide all config sections
    document.querySelectorAll('[id$="_config"]').forEach(el => el.classList.add('hidden'));
    
    // Show selected config
    const configEl = document.getElementById(actionType + '_config');
    if (configEl) {
        configEl.classList.remove('hidden');
    }
}

document.getElementById('createRouteForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {};
    
    // Convert form data to object
    for (const [key, value] of formData.entries()) {
        if (key === 'requires_auth') {
            data[key] = true;
        } else if (['temperature', 'top_k', 'max_tokens', 'rate_limit', 'cache_ttl'].includes(key)) {
            data[key] = parseFloat(value);
        } else {
            data[key] = value;
        }
    }
    
    // Add unchecked checkbox
    if (!formData.has('requires_auth')) {
        data.requires_auth = false;
    }
    
    try {
        const response = await axios.post('/admin/routes/create', data);
        if (response.data.success) {
            alert('Route created successfully!');
            window.location.href = '/admin/routes';
        }
    } catch (error) {
        alert('Error creating route: ' + (error.response?.data?.error || error.message));
    }
});
</script>
{% endblock %}