{% extends "base.html" %}

{% block title %}AI Instructions - Cinematch Admin{% endblock %}

{% block extra_head %}
<style>
    .instruction-card {
        background: #374151;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid transparent;
        transition: all 0.3s;
    }
    .instruction-card.active {
        border-left-color: #10b981;
    }
    .instruction-card.inactive {
        border-left-color: #6b7280;
        opacity: 0.7;
    }
    .instruction-type {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .type-system { background: #3b82f6; }
    .type-behavior { background: #10b981; }
    .type-context { background: #f59e0b; }
    .type-style { background: #8b5cf6; }
    .type-safety { background: #ef4444; }
    
    .code-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 6px;
        padding: 1rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #e2e8f0;
    }
    
    .condition-builder {
        background: #1e293b;
        border-radius: 6px;
        padding: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include 'admin/nav.html' %}
    
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold">AI Agent Instructions</h2>
            <div class="flex gap-3">
                <button onclick="exportInstructions()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
                <button onclick="importInstructions()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    <i class="fas fa-upload mr-2"></i>Import
                </button>
                <button onclick="showAddInstructionModal()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                    <i class="fas fa-plus mr-2"></i>Add Instruction
                </button>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-gray-800 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-400">{{ stats.system }}</div>
                <div class="text-sm text-gray-400">System</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-400">{{ stats.behavior }}</div>
                <div class="text-sm text-gray-400">Behavior</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-yellow-400">{{ stats.context }}</div>
                <div class="text-sm text-gray-400">Context</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-purple-400">{{ stats.style }}</div>
                <div class="text-sm text-gray-400">Style</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-red-400">{{ stats.safety }}</div>
                <div class="text-sm text-gray-400">Safety</div>
            </div>
        </div>
        
        <!-- Filter Tabs -->
        <div class="bg-gray-800 rounded-lg p-1 mb-6">
            <div class="flex space-x-1">
                <button onclick="filterInstructions('all')" class="filter-tab px-4 py-2 rounded active">
                    All Instructions
                </button>
                <button onclick="filterInstructions('system')" class="filter-tab px-4 py-2 rounded">
                    System
                </button>
                <button onclick="filterInstructions('behavior')" class="filter-tab px-4 py-2 rounded">
                    Behavior
                </button>
                <button onclick="filterInstructions('context')" class="filter-tab px-4 py-2 rounded">
                    Context
                </button>
                <button onclick="filterInstructions('style')" class="filter-tab px-4 py-2 rounded">
                    Style
                </button>
                <button onclick="filterInstructions('safety')" class="filter-tab px-4 py-2 rounded">
                    Safety
                </button>
            </div>
        </div>
        
        <!-- Instructions List -->
        <div id="instructionsList">
            {% for instruction in instructions %}
            <div class="instruction-card {% if instruction.active %}active{% else %}inactive{% endif %}" 
                 data-type="{{ instruction.instruction_type }}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-lg font-semibold flex items-center gap-3">
                            {{ instruction.name }}
                            <span class="instruction-type type-{{ instruction.instruction_type }}">
                                {{ instruction.instruction_type }}
                            </span>
                            <span class="text-sm text-gray-400">Priority: {{ instruction.priority }}</span>
                        </h3>
                        <p class="text-sm text-gray-400 mt-1">
                            Created: {{ instruction.created_at.strftime('%Y-%m-%d %H:%M') }}
                            {% if instruction.updated_at != instruction.created_at %}
                                | Updated: {{ instruction.updated_at.strftime('%Y-%m-%d %H:%M') }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editInstruction({{ instruction.id }})" 
                                class="text-blue-400 hover:text-blue-300 p-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="toggleInstruction({{ instruction.id }})" 
                                class="text-yellow-400 hover:text-yellow-300 p-2">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <button onclick="deleteInstruction({{ instruction.id }})" 
                                class="text-red-400 hover:text-red-300 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Content Preview -->
                <div class="bg-gray-900 rounded p-3 mb-3">
                    <pre class="text-sm text-gray-300 whitespace-pre-wrap">{{ instruction.content[:200] }}{% if instruction.content|length > 200 %}...{% endif %}</pre>
                </div>
                
                <!-- Conditions -->
                {% if instruction.conditions %}
                <div class="mb-3">
                    <h4 class="text-sm font-medium mb-2 text-gray-400">Conditions:</h4>
                    <div class="bg-gray-900 rounded p-2">
                        <code class="text-xs">{{ instruction.conditions|tojson|safe }}</code>
                    </div>
                </div>
                {% endif %}
                
                <!-- Metadata -->
                {% if instruction.metadata and instruction.metadata.is_default %}
                <div class="flex items-center gap-2 text-sm text-gray-400">
                    <i class="fas fa-info-circle"></i>
                    <span>Default instruction</span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add/Edit Instruction Modal -->
<div id="instructionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <h3 class="text-2xl font-bold mb-6" id="modalTitle">Add AI Instruction</h3>
            
            <form id="instructionForm">
                <input type="hidden" id="instructionId">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2">Name</label>
                        <input type="text" id="instructionName" required
                               class="w-full p-2 rounded bg-gray-700 text-white"
                               placeholder="e.g., weekend_recommendations">
                    </div>
                    
                    <div>
                        <label class="block mb-2">Type</label>
                        <select id="instructionType" required
                                class="w-full p-2 rounded bg-gray-700 text-white">
                            <option value="system">System</option>
                            <option value="behavior">Behavior</option>
                            <option value="context">Context</option>
                            <option value="style">Style</option>
                            <option value="safety">Safety</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block mb-2">Priority</label>
                        <input type="number" id="instructionPriority" min="1" max="100" value="1"
                               class="w-full p-2 rounded bg-gray-700 text-white">
                        <p class="text-xs text-gray-400 mt-1">Higher priority instructions override lower ones</p>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="instructionActive" checked class="mr-2">
                            Active
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block mb-2">Instruction Content</label>
                    <textarea id="instructionContent" rows="10" required
                              class="w-full code-editor"
                              placeholder="Enter the instruction content..."></textarea>
                </div>
                
                <!-- Conditions Builder -->
                <div class="mb-4">
                    <label class="block mb-2">
                        Conditions (Optional)
                        <button type="button" onclick="addCondition()" 
                                class="ml-2 text-sm bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded">
                            <i class="fas fa-plus"></i> Add Condition
                        </button>
                    </label>
                    <div id="conditionsContainer" class="condition-builder">
                        <!-- Conditions will be added here -->
                    </div>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeInstructionModal()"
                            class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded">
                        Save Instruction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-lg max-w-2xl w-full p-6">
        <h3 class="text-xl font-bold mb-4">Import Instructions</h3>
        
        <div class="mb-4">
            <label class="block mb-2">Paste JSON data or select file</label>
            <textarea id="importData" rows="10"
                      class="w-full p-3 rounded bg-gray-700 text-white font-mono text-sm"
                      placeholder='{"instructions": [...]}'>
            </textarea>
        </div>
        
        <div class="mb-4">
            <input type="file" id="importFile" accept=".json" 
                   onchange="loadImportFile(event)"
                   class="block w-full text-sm text-gray-400">
        </div>
        
        <div class="flex justify-end gap-3">
            <button onclick="closeImportModal()"
                    class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                Cancel
            </button>
            <button onclick="performImport()"
                    class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                Import
            </button>
        </div>
    </div>
</div>

<script>
// Current filter
let currentFilter = 'all';

// Filter instructions
function filterInstructions(type) {
    currentFilter = type;
    
    // Update tab styles
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('bg-gray-700', 'text-white');
        tab.classList.add('text-gray-400', 'hover:text-white');
    });
    event.target.classList.add('bg-gray-700', 'text-white');
    
    // Filter cards
    document.querySelectorAll('.instruction-card').forEach(card => {
        if (type === 'all' || card.dataset.type === type) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Show add instruction modal
function showAddInstructionModal() {
    document.getElementById('modalTitle').textContent = 'Add AI Instruction';
    document.getElementById('instructionForm').reset();
    document.getElementById('instructionId').value = '';
    document.getElementById('conditionsContainer').innerHTML = '';
    document.getElementById('instructionModal').classList.remove('hidden');
}

// Edit instruction
async function editInstruction(id) {
    try {
        const response = await axios.get(`/admin/ai-instructions/${id}`);
        const instruction = response.data;
        
        document.getElementById('modalTitle').textContent = 'Edit AI Instruction';
        document.getElementById('instructionId').value = instruction.id;
        document.getElementById('instructionName').value = instruction.name;
        document.getElementById('instructionType').value = instruction.instruction_type;
        document.getElementById('instructionPriority').value = instruction.priority;
        document.getElementById('instructionActive').checked = instruction.active;
        document.getElementById('instructionContent').value = instruction.content;
        
        // Load conditions
        const container = document.getElementById('conditionsContainer');
        container.innerHTML = '';
        if (instruction.conditions) {
            Object.entries(instruction.conditions).forEach(([key, value]) => {
                addCondition(key, value);
            });
        }
        
        document.getElementById('instructionModal').classList.remove('hidden');
    } catch (error) {
        alert('Error loading instruction');
    }
}

// Add condition
function addCondition(key = '', value = '') {
    const container = document.getElementById('conditionsContainer');
    const conditionDiv = document.createElement('div');
    conditionDiv.className = 'flex gap-2 mb-2';
    conditionDiv.innerHTML = `
        <input type="text" placeholder="Key" value="${key}"
               class="flex-1 p-2 rounded bg-gray-700 text-white condition-key">
        <input type="text" placeholder="Value" value="${typeof value === 'object' ? JSON.stringify(value) : value}"
               class="flex-1 p-2 rounded bg-gray-700 text-white condition-value">
        <button type="button" onclick="this.parentElement.remove()"
                class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(conditionDiv);
}

// Close instruction modal
function closeInstructionModal() {
    document.getElementById('instructionModal').classList.add('hidden');
}

// Save instruction
document.getElementById('instructionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Collect conditions
    const conditions = {};
    document.querySelectorAll('#conditionsContainer > div').forEach(div => {
        const key = div.querySelector('.condition-key').value;
        const value = div.querySelector('.condition-value').value;
        if (key) {
            try {
                conditions[key] = JSON.parse(value);
            } catch {
                conditions[key] = value;
            }
        }
    });
    
    const data = {
        name: document.getElementById('instructionName').value,
        instruction_type: document.getElementById('instructionType').value,
        content: document.getElementById('instructionContent').value,
        priority: parseInt(document.getElementById('instructionPriority').value),
        active: document.getElementById('instructionActive').checked,
        conditions: Object.keys(conditions).length > 0 ? conditions : null
    };
    
    try {
        const id = document.getElementById('instructionId').value;
        if (id) {
            await axios.put(`/admin/ai-instructions/${id}`, data);
            alert('Instruction updated successfully');
        } else {
            await axios.post('/admin/ai-instructions', data);
            alert('Instruction added successfully');
        }
        location.reload();
    } catch (error) {
        alert('Error saving instruction: ' + (error.response?.data?.error || error.message));
    }
});

// Toggle instruction
async function toggleInstruction(id) {
    try {
        await axios.post(`/admin/ai-instructions/${id}/toggle`);
        location.reload();
    } catch (error) {
        alert('Error toggling instruction');
    }
}

// Delete instruction
async function deleteInstruction(id) {
    if (!confirm('Are you sure you want to delete this instruction?')) return;
    
    try {
        await axios.delete(`/admin/ai-instructions/${id}`);
        location.reload();
    } catch (error) {
        alert('Error deleting instruction');
    }
}

// Export instructions
async function exportInstructions() {
    try {
        const response = await axios.get('/admin/ai-instructions/export');
        const blob = new Blob([JSON.stringify(response.data, null, 2)], {type: 'application/json'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai_instructions_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    } catch (error) {
        alert('Error exporting instructions');
    }
}

// Import instructions
function importInstructions() {
    document.getElementById('importModal').classList.remove('hidden');
}

function closeImportModal() {
    document.getElementById('importModal').classList.add('hidden');
}

function loadImportFile(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('importData').value = e.target.result;
        };
        reader.readAsText(file);
    }
}

async function performImport() {
    const data = document.getElementById('importData').value;
    
    try {
        const parsed = JSON.parse(data);
        const response = await axios.post('/admin/ai-instructions/import', parsed);
        alert(`Successfully imported ${response.data.count} instructions`);
        location.reload();
    } catch (error) {
        alert('Error importing instructions: ' + (error.response?.data?.error || error.message));
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set active tab
    document.querySelector('.filter-tab').classList.add('bg-gray-700', 'text-white');
});
</script>

<style>
.filter-tab {
    transition: all 0.2s;
}
.filter-tab:not(.bg-gray-700) {
    @apply text-gray-400 hover:text-white;
}
</style>
{% endblock %}