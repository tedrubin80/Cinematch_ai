{% extends "base.html" %}

{% block title %}API Key Management - Cinematch Admin{% endblock %}

{% block extra_head %}
<style>
    .api-key-input {
        font-family: monospace;
        background: #1a1a1a;
    }
    .key-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .key-active { background: #10b981; }
    .key-inactive { background: #ef4444; }
    .routing-rule {
        background: #374151;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen">
    {% include 'admin/nav.html' %}
    
    <div class="container mx-auto px-4 py-8">
        <h2 class="text-3xl font-bold mb-8">API Key & Routing Management</h2>
        
        <!-- API Keys Section -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">API Keys</h3>
            
            <div class="space-y-4">
                <!-- OpenAI Key -->
                <div class="border border-gray-700 p-4 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-medium">OpenAI API Key (Required for embeddings)</h4>
                        <span class="key-status {% if api_keys.openai %}key-active{% else %}key-inactive{% endif %}"></span>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" 
                               id="openai-key" 
                               class="flex-1 p-2 rounded bg-gray-700 text-white api-key-input"
                               placeholder="sk-..." 
                               value="{% if api_keys.openai %}••••••••••••••••{% endif %}">
                        <button onclick="updateApiKey('openai')" 
                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            Update
                        </button>
                    </div>
                    <p class="text-sm text-gray-400 mt-1">Used for generating embeddings</p>
                </div>
                
                <!-- Anthropic Key -->
                <div class="border border-gray-700 p-4 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-medium">Anthropic API Key (Claude)</h4>
                        <span class="key-status {% if api_keys.anthropic %}key-active{% else %}key-inactive{% endif %}"></span>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" 
                               id="anthropic-key" 
                               class="flex-1 p-2 rounded bg-gray-700 text-white api-key-input"
                               placeholder="sk-ant-..." 
                               value="{% if api_keys.anthropic %}••••••••••••••••{% endif %}">
                        <button onclick="updateApiKey('anthropic')" 
                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            Update
                        </button>
                    </div>
                    <p class="text-sm text-gray-400 mt-1">Used for mature content and complex queries</p>
                </div>
                
                <!-- Google Key -->
                <div class="border border-gray-700 p-4 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-medium">Google API Key (Gemini)</h4>
                        <span class="key-status {% if api_keys.google %}key-active{% else %}key-inactive{% endif %}"></span>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" 
                               id="google-key" 
                               class="flex-1 p-2 rounded bg-gray-700 text-white api-key-input"
                               placeholder="AIza..." 
                               value="{% if api_keys.google %}••••••••••••••••{% endif %}">
                        <button onclick="updateApiKey('google')" 
                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            Update
                        </button>
                    </div>
                    <p class="text-sm text-gray-400 mt-1">Used for general content queries</p>
                </div>
            </div>
        </div>
        
        <!-- LangChain Routing Configuration -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">LangChain Routing Configuration</h3>
            
            <form id="routing-config-form">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2">Claude Usage Threshold</label>
                        <input type="range" 
                               id="claude-threshold" 
                               min="0" max="1" step="0.1" 
                               value="{{ routing_config.use_claude_threshold }}"
                               class="w-full">
                        <span id="claude-value">{{ routing_config.use_claude_threshold }}</span>
                        <p class="text-sm text-gray-400">Higher = More likely to use Claude</p>
                    </div>
                    
                    <div>
                        <label class="block mb-2">Gemini Usage Threshold</label>
                        <input type="range" 
                               id="gemini-threshold" 
                               min="0" max="1" step="0.1" 
                               value="{{ routing_config.use_gemini_threshold }}"
                               class="w-full">
                        <span id="gemini-value">{{ routing_config.use_gemini_threshold }}</span>
                        <p class="text-sm text-gray-400">Lower = More likely to use Gemini</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block mb-2">Content Length Threshold (characters)</label>
                    <input type="number" 
                           id="content-length-threshold" 
                           value="{{ routing_config.content_length_threshold }}"
                           class="w-full p-2 rounded bg-gray-700 text-white">
                    <p class="text-sm text-gray-400">Longer queries may be routed to Claude</p>
                </div>
                
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" 
                               id="enable-cross-validation" 
                               {% if routing_config.enable_cross_validation %}checked{% endif %}
                               class="mr-2">
                        Enable Cross-Validation Between LLMs
                    </label>
                    <p class="text-sm text-gray-400">Use both LLMs for important queries and compare responses</p>
                </div>
                
                <div class="mb-4">
                    <label class="block mb-2">Cross-Validation Keywords (comma-separated)</label>
                    <input type="text" 
                           id="cross-validation-keywords" 
                           value="{{ routing_config.cross_validation_keywords }}"
                           placeholder="recommendation, suggest, best"
                           class="w-full p-2 rounded bg-gray-700 text-white">
                </div>
                
                <button type="submit" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded">
                    Save Routing Configuration
                </button>
            </form>
        </div>
        
        <!-- Custom Routing Rules -->
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Custom Routing Rules</h3>
            
            <div id="routing-rules">
                {% for rule in content_rules %}
                <div class="routing-rule">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-medium">{{ rule.rule_name }}</h4>
                            <p class="text-sm text-gray-400">
                                Type: {{ rule.condition_type }} | 
                                Target: {{ rule.target_llm }} | 
                                Priority: {{ rule.priority }}
                            </p>
                            <code class="text-xs">{{ rule.condition_value }}</code>
                        </div>
                        <button onclick="deleteRule({{ rule.id }})" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <button onclick="showAddRuleModal()" class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                <i class="fas fa-plus"></i> Add New Rule
            </button>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div id="addRuleModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full">
        <h3 class="text-xl font-bold mb-4">Add Routing Rule</h3>
        
        <form id="add-rule-form">
            <div class="mb-4">
                <label class="block mb-2">Rule Name</label>
                <input type="text" id="rule-name" required class="w-full p-2 rounded bg-gray-700 text-white">
            </div>
            
            <div class="mb-4">
                <label class="block mb-2">Condition Type</label>
                <select id="condition-type" class="w-full p-2 rounded bg-gray-700 text-white">
                    <option value="keyword">Keyword Match</option>
                    <option value="regex">Regular Expression</option>
                    <option value="sentiment">Sentiment Score</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2">Condition Value</label>
                <input type="text" id="condition-value" required class="w-full p-2 rounded bg-gray-700 text-white">
            </div>
            
            <div class="mb-4">
                <label class="block mb-2">Target LLM</label>
                <select id="target-llm" class="w-full p-2 rounded bg-gray-700 text-white">
                    <option value="claude">Claude</option>
                    <option value="gemini">Gemini</option>
                    <option value="both">Both (Cross-validate)</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2">Priority (1-10)</label>
                <input type="number" id="priority" min="1" max="10" value="5" class="w-full p-2 rounded bg-gray-700 text-white">
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                    Add Rule
                </button>
                <button type="button" onclick="hideAddRuleModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Update API Key
async function updateApiKey(service) {
    const keyInput = document.getElementById(`${service}-key`);
    const key = keyInput.value.trim();
    
    if (!key) {
        alert('Please enter a valid API key');
        return;
    }
    
    try {
        const response = await axios.post('{{ url_for("admin.update_api_keys") }}', {
            service: service,
            key: key
        });
        
        if (response.data.success) {
            alert(response.data.message);
            keyInput.value = '••••••••••••••••';
            location.reload();
        }
    } catch (error) {
        alert('Error updating API key: ' + error.response.data.error);
    }
}

// Update routing configuration
document.getElementById('routing-config-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const config = {
        claude_threshold: parseFloat(document.getElementById('claude-threshold').value),
        gemini_threshold: parseFloat(document.getElementById('gemini-threshold').value),
        content_length_threshold: parseInt(document.getElementById('content-length-threshold').value),
        enable_cross_validation: document.getElementById('enable-cross-validation').checked,
        cross_validation_keywords: document.getElementById('cross-validation-keywords').value.split(',').map(k => k.trim())
    };
    
    try {
        const response = await axios.post('{{ url_for("admin.update_routing_config") }}', config);
        if (response.data.success) {
            alert('Routing configuration updated successfully');
        }
    } catch (error) {
        alert('Error updating configuration');
    }
});

// Update slider values
document.getElementById('claude-threshold').addEventListener('input', (e) => {
    document.getElementById('claude-value').textContent = e.target.value;
});

document.getElementById('gemini-threshold').addEventListener('input', (e) => {
    document.getElementById('gemini-value').textContent = e.target.value;
});

// Rule management
function showAddRuleModal() {
    document.getElementById('addRuleModal').classList.remove('hidden');
}

function hideAddRuleModal() {
    document.getElementById('addRuleModal').classList.add('hidden');
}

document.getElementById('add-rule-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const rule = {
        name: document.getElementById('rule-name').value,
        condition_type: document.getElementById('condition-type').value,
        condition_value: document.getElementById('condition-value').value,
        target_llm: document.getElementById('target-llm').value,
        priority: parseInt(document.getElementById('priority').value)
    };
    
    try {
        const response = await axios.post('{{ url_for("admin.add_routing_rule") }}', rule);
        if (response.data.success) {
            alert('Rule added successfully');
            location.reload();
        }
    } catch (error) {
        alert('Error adding rule');
    }
});

async function deleteRule(ruleId) {
    if (confirm('Delete this routing rule?')) {
        try {
            await axios.delete(`/admin/routing-rules/${ruleId}`);
            location.reload();
        } catch (error) {
            alert('Error deleting rule');
        }
    }
}
</script>
{% endblock %}